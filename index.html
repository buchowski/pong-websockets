<!DOCTYPE html>
<html>
  <head>
    <title>Ping Pong</title>
    <style>
      #board {
        background-color: dimgray;
      }
      #left-paddle {
        fill: red;
      }
      #right-paddle {
        fill: lightskyblue;
      }
    </style>
  </head>
  <body>
    <svg id="board">
      <rect id="left-paddle" width="10px" height="40px" />
      <rect id="right-paddle" width="10px" height="40px" />
    </svg>
    <form>
      <label>name:
        <input name="player-name" type="text" />
      </label>
      <button type="submit">Save</button>
    </form>
    <script src="/socket.io/socket.io.js"></script>
    <script>
      var socket = io();  
      let playerId;

      // constants
      const UP = 'UP';
      const DOWN = 'DOWN';
      const IDLE = 'IDLE';
      const svgHeight = 400;
      const svgWidth = 600;
      const deltaUnit = 3;

      // leftPaddle
      let leftX = 50;
      let leftY = 100;
      let deltaY = 0;
      let paddleDirection = IDLE;

      // rightPaddle
      let rightX = 500;
      let rightY = 50;

      // dom elements
      const form = document.querySelector('form');
      const board = document.getElementById('board');
      const leftPaddle = document.getElementById('left-paddle');
      const rightPaddle = document.getElementById('right-paddle');

      // helpers
      const isTooHigh = y => y <= 0;
      const isTooLow = y => y + 40 >= svgHeight;
      
      // initialize
      board.setAttribute('viewBox', `0 0 ${svgWidth} ${svgHeight}`);
      leftPaddle.setAttribute('x', leftX);
      leftPaddle.setAttribute('y', leftY);
      rightPaddle.setAttribute('x', rightX);
      rightPaddle.setAttribute('y', rightY);
      
      // emit websocket msg if ball pos has changed
      setInterval(emitMessageLoop = () => {
        if (paddleDirection === IDLE) {
          return;
        }

        if (isTooHigh(leftY)) {
          paddleDirection = DOWN;
        } else if (isTooLow(leftY)) {
          paddleDirection = UP;
        }

        deltaY = paddleDirection === DOWN ? deltaUnit : -deltaUnit; 
        leftY += deltaY;
        leftPaddle.setAttribute('y', leftY);
        rightPaddle.setAttribute('y', rightY);

        socket.emit('ballMove', {id: playerId, y: leftY});
      }, 50);

      let isOtherPlayersMove;
      socket.on('ballMove', function syncServer(data) {
        isOtherPlayersMove = data.id !== playerId;

        if (isOtherPlayersMove) {
          rightY = data.y;
        }
      });

      const enableGameControls = () => {
        document.addEventListener('keydown', function movePaddle(e) {
          e.preventDefault();
  
          switch (e.key) {
            case 'w':
              paddleDirection = UP;
              break;
            case 's':
              paddleDirection = DOWN;
              break;
            case 'd':
              paddleDirection = IDLE;
          }
        });
      }

      const startGame = () => {
        enableGameControls();
      }

      form.addEventListener('submit', function savePlayerInfo(e) {
        e.preventDefault();
        const formData = new FormData(form);
        const playerName = formData.get('player-name')

        playerId = playerName;

        startGame();
      })
    </script>
  </body>
</html>